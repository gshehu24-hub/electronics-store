package electronicstore.controller;

import electronicstore.model.exceptions.InvalidCredentialsException;
import electronicstore.model.users.Administrator;
import electronicstore.model.users.Cashier;
import electronicstore.model.users.User;
import electronicstore.model.utilities.FileManager;

import java.time.LocalDate;
import java.util.List;

public class LoginController {
    private List<User> users;

    public LoginController() {
        loadUsers();
        ensureDefaultAdmin();
    }

    private void ensureDefaultAdmin() {
        boolean adminExists = users.stream().anyMatch(user -> user.getUsername().equals("admin"));
        if (!adminExists) {
            // Create default admin
            Administrator admin = new Administrator("admin", "admin123", "Default Admin",
                    LocalDate.of(1980, 1, 1), "1234567890", "admin@store.com", 5000.0);
            users.add(admin);
            try {
                FileManager.saveUsers(users);
            } catch (Exception e) {
                System.err.println("Error saving default admin: " + e.getMessage());
            }
        }
    }

    public User authenticate(String username, String password) throws InvalidCredentialsException {
        for (User user : users) {
            if (user.getUsername().equals(username)) {
                user.login(username, password);
                // Load additional data for admin and cashier users
                if (user instanceof Administrator) {
                    ((Administrator) user).loadEmployees();
                } else if (user instanceof Cashier) {
                    ((Cashier) user).loadInventory();
                }
                return user;
            }
        }
        throw new InvalidCredentialsException("User not found");
    }

    private void loadUsers() {
        try {
            users = FileManager.loadUsers();
        } catch (Exception e) {
            users = new java.util.ArrayList<>();
        }
    }
}