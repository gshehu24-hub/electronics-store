package electronicstore.model.users;

import electronicstore.model.exceptions.ItemNotFoundException;
import electronicstore.model.inventory.*;
import electronicstore.model.transactions.Statistics;
import electronicstore.model.utilities.FileManager;

import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;

public class Manager extends User {
    private static final long serialVersionUID = 1L;

    private List<Sector> sectors;
    private List<Supplier> suppliers;

    public Manager(String username, String password, String name, LocalDate dateOfBirth,
                   String phoneNumber, String email, double salary) {
        super(username, password, name, dateOfBirth, phoneNumber, email, salary, AccessLevel.MANAGER);
        this.sectors = new ArrayList<>();
        this.suppliers = new ArrayList<>();
    }

    @Override
    public void displayDashboard() {
        System.out.println("Manager Dashboard");
    }

    public void addItemToStock(Item item) {
        // Add item to its sector. If sector doesn't exist, add the sector.
        if (item == null) return;

        Sector itemSector = item.getSector();
        if (itemSector != null) {
            // Try to find existing sector by ID
            Sector found = null;
            for (Sector sector : sectors) {
                if (sector.getSectorID().equals(itemSector.getSectorID())) {
                    found = sector;
                    break;
                }
            }
            if (found == null) {
                // Use the item's sector (ensure its items list is initialized)
                itemSector.setItems(new java.util.ArrayList<>());
                sectors.add(itemSector);
                found = itemSector;
            }
            // If an item with same ID exists, update its quantity and fields instead of silently adding duplicate
            boolean merged = false;
            for (Item existing : found.getItems()) {
                if (existing.getItemID().equals(item.getItemID())) {
                    // merge: update quantity and other mutable fields
                    existing.setQuantity(existing.getQuantity() + item.getQuantity());
                    existing.setSellingPrice(item.getSellingPrice());
                    existing.setPurchasePrice(item.getPurchasePrice());
                    existing.setPurchaseDate(item.getPurchaseDate());
                    existing.setSupplier(item.getSupplier());
                    merged = true;
                    break;
                }
            }
            if (!merged) {
                found.getItems().add(item);
            }
        } else {
            // No sector specified: add to a default sector or create one
            if (sectors.isEmpty()) {
                Sector defaultSector = new Sector("SEC-000", "Default", "Default sector");
                defaultSector.getItems().add(item);
                sectors.add(defaultSector);
            } else {
                sectors.get(0).getItems().add(item);
            }
        }

        // Ensure supplier is tracked
        if (item.getSupplier() != null) {
            boolean exists = false;
            for (Supplier s : suppliers) {
                if (s.getSupplierID().equals(item.getSupplier().getSupplierID())) {
                    exists = true;
                    break;
                }
            }
            if (!exists) suppliers.add(item.getSupplier());
        }

        saveInventory();
    }

    public void addCategory(Category category) {
        // Add to sectors
        for (Sector sector : sectors) {
            sector.getItems().addAll(category.getItems());
        }
        saveInventory();
    }

    public void applyDiscount(String itemID, double percent) throws ItemNotFoundException {
        for (Sector sector : sectors) {
            for (Item item : sector.getItems()) {
                if (item.getItemID().equals(itemID)) {
                    item.applyDiscount(percent);
                    saveInventory();
                    return;
                }
            }
        }
        throw new ItemNotFoundException(itemID);
    }

    public List<Item> checkStockAlerts() {
        List<Item> lowStockItems = new ArrayList<>();
        for (Sector sector : sectors) {
            lowStockItems.addAll(sector.getLowStockItems());
        }
        return lowStockItems;
    }

    public Statistics viewCashierPerformance(String cashierUsername, LocalDate startDate, LocalDate endDate) {
        // This would require bill data, for now return empty stats
        return new Statistics(startDate, endDate, cashierUsername);
    }

    public void addSupplier(Supplier supplier) {
        suppliers.add(supplier);
        saveInventory();
    }

    public void updateSupplier(Supplier supplier) {
        // Since supplier is already in the list, just save
        saveInventory();
    }

    public void deleteItem(String itemID) throws ItemNotFoundException {
        for (Sector sector : sectors) {
            for (Item item : sector.getItems()) {
                if (item.getItemID().equals(itemID)) {
                    sector.getItems().remove(item);
                    saveInventory();
                    return;
                }
            }
        }
        throw new ItemNotFoundException(itemID);
    }

    public void deleteSupplier(String supplierID) throws Exception {
        Supplier toRemove = null;
        for (Supplier supplier : suppliers) {
            if (supplier.getSupplierID().equals(supplierID)) {
                toRemove = supplier;
                break;
            }
        }
        if (toRemove != null) {
            suppliers.remove(toRemove);
            saveInventory();
        } else {
            throw new Exception("Supplier not found: " + supplierID);
        }
    }

    public void saveInventory() {
        try {
            List<Item> allItems = new ArrayList<>();
            for (Sector sector : sectors) {
                allItems.addAll(sector.getItems());
            }
            FileManager.saveItems(allItems);
            FileManager.saveSuppliers(suppliers);
            FileManager.saveSectors(sectors);
        } catch (Exception e) {
            System.err.println("Error saving inventory: " + e.getMessage());
        }
    }

    public void loadInventory() {
        try {
            List<Item> items = FileManager.loadItems();
            suppliers = FileManager.loadSuppliers();
            sectors = FileManager.loadSectors();
            
            // Assign items to sectors
            java.util.Map<String, Sector> sectorMap = new java.util.HashMap<>();
            // populate map with loaded sectors
            for (Sector s : sectors) {
                sectorMap.put(s.getSectorID(), s);
            }

            for (Item item : items) {
                if (item.getSector() != null) {
                    String sid = item.getSector().getSectorID();
                    Sector target = sectorMap.get(sid);
                    if (target == null) {
                        // sector not present in loaded sectors, use item's sector
                        Sector newSector = item.getSector();
                        if (newSector.getItems() == null) newSector.setItems(new java.util.ArrayList<>());
                        sectors.add(newSector);
                        sectorMap.put(newSector.getSectorID(), newSector);
                        target = newSector;
                    }
                    target.getItems().add(item);
                } else {
                    // Item has no sector: add to a default sector
                    if (sectors.isEmpty()) {
                        Sector defaultSector = new Sector("SEC-000", "Default", "Default sector");
                        sectors.add(defaultSector);
                    }
                    sectors.get(0).getItems().add(item);
                }

                // ensure supplier tracked
                if (item.getSupplier() != null) {
                    boolean foundSup = false;
                    for (Supplier s : suppliers) {
                        if (s.getSupplierID().equals(item.getSupplier().getSupplierID())) { foundSup = true; break; }
                    }
                    if (!foundSup) suppliers.add(item.getSupplier());
                }
            }
        } catch (Exception e) {
            sectors = new ArrayList<>();
            suppliers = new ArrayList<>();
        }
    }

    public List<Sector> getSectors() { return sectors; }
    public List<Supplier> getSuppliers() { return suppliers; }
}